services:

  # Builds the Jekyll site once for local development.
  # Applies development overrides (empty baseurl).
  # Generates the static output in the _site directory.
  jekyll:
    build: .
    container_name: jekyll-ghp
    working_dir: /site
    volumes:
      - .:/site
      - bundle_cache:/bundle
    environment:
      - JEKYLL_ENV=development
    command: >
      bash -lc "
      bundle install &&
      bundle exec jekyll build --config _config.yml,_config.dev.yml
      "

  # Continuously watches files and rebuilds the site on changes.
  # Keeps the _site directory updated during active development.
  # Uses the same development configuration for consistent URLs.
  jekyll-watch:
    build: .
    container_name: jekyll-watch
    working_dir: /site
    volumes:
      - .:/site
      - bundle_cache:/bundle
    environment:
      - JEKYLL_ENV=development
    command: >
      bash -lc "
      bundle install &&
      bundle exec jekyll build --config _config.yml,_config.dev.yml --watch
      "

  # Serves the generated static site via nginx.
  # Has no awareness of Jekyll or configuration files.
  # Exposes the contents of the _site directory over HTTP.
  web:
    image: nginx:alpine
    container_name: jekyll-web
    depends_on:
      - jekyll
    volumes:
      - ./_site:/usr/share/nginx/html:ro
    ports:
      - "8080:80"

volumes:
  bundle_cache:
